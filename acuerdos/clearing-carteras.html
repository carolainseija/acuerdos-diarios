<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cruce de Archivos Excel</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.1/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="/">Home</a>
                    </li>
                </ul>
                <span class="navbar-text">
                    cruce por Cartera Clearing

                </span>
            </div>
        </div>
    </nav>
    <div class="container py-5">
        <div class="row">
            <div class="col-md-12">
                <h4>Acuerdos de Clearing sin Cartera</h4>
                <input type="file" id="fileAcuerdos" class="form-control mb-2" accept=".xlsx,.xls">
            </div>
        </div>
        <div class="row py-5">

            <div class="col-md-6">
                <h6>Cruce de stock POLAKOF</h6>
                <input type="file" id="fileCarteraPola" class="form-control mb-2" accept=".xlsx,.xls">
                
                <button class="btn btn-primary" onclick="procesarPolakof()">Agregar Cartera de Polakof</button>
                <div id="responseMessagePkf" class="mt-4"></div>

                <!-- responseMessagePkf -->
          
            </div>
            <div class="col-md-6">
                <h6>Cruce de stock AVON</h6>
                <input type="file" id="fileCarteraAv" class="form-control mb-2" accept=".xlsx,.xls">
                <button class="btn btn-primary" onclick="procesarAvon()">Agregar Cartera de Avon</button>
                <p>El archivo de stock puede tener el guion en la ci, eso esta contemplado</p>
                <div id="responseMessageAv" class="mt-4"></div>

            </div>
        </div>
    </div>

    <script>
        function procesarPolakof() {
            async function procesarArchivos() {
                const fileAcuerdos = document.getElementById('fileAcuerdos').files[0];
                const fileCartera = document.getElementById('fileCarteraPola').files[0];

                if (!fileAcuerdos || !fileCartera) {
                    alert('Seleccione ambos archivos');
                    return;
                }

                const [acuerdosData, carteraData] = await Promise.all([
                    leerExcel(fileAcuerdos),
                    leerExcel(fileCartera)
                ]);

                if (!acuerdosData.length || !carteraData.length) {
                    alert('Los archivos están vacíos o no contienen datos válidos');
                    return;
                }

                const normalizarCabeceras = obj => Object.keys(obj).reduce((acc, key) => {
                    acc[key.trim()] = obj[key];
                    return acc;
                }, {});

                const acuerdosNormalizados = acuerdosData.map(normalizarCabeceras);
                const carteraNormalizada = carteraData.map(normalizarCabeceras);

                if (!acuerdosNormalizados[0].hasOwnProperty("Ci") || !carteraNormalizada[0].hasOwnProperty("Cliente")) {
                    alert('Verifique que los archivos contengan las cabeceras correctas (Ci y Cliente)');
                    return;
                }

                // Crear un set de CIs de la cartera
                let documentosCartera = new Set(carteraNormalizada.map(row => String(row["Cliente"]).trim()));

                const responseMessagePkf = document.getElementById('responseMessagePkf');

                // Filtrar solo los registros cuyo "Ci" existe en la cartera y agregar "Cartera: Polakof"
                const acuerdosFiltrados = acuerdosNormalizados
                    .filter(row => documentosCartera.has(String(row["Ci"]).trim()))
                    .map(row => ({ ...row, "Cartera": "Polakof" }));

                if (acuerdosFiltrados.length === 0) {
                    responseMessagePkf.innerHTML = "<div class='alert alert-danger text-center'>❌ No se encontraron ci en polakof.</div>";
                    return;
                }

                descargarExcel(acuerdosFiltrados, 'Polakof.xlsx');
            }

            function leerExcel(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const sheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(sheet);
                        resolve(jsonData);
                    };
                    reader.onerror = reject;
                    reader.readAsArrayBuffer(file);
                });
            }

            function descargarExcel(data, filename) {
                const workbook = new ExcelJS.Workbook();
                const worksheet = workbook.addWorksheet("Datos");

                const headerRow = worksheet.addRow(Object.keys(data[0] || {}));
                const headerStyle = {
                    font: { bold: true, color: { argb: 'FFFFFFFF' } },
                    fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF002060' } },
                    alignment: { horizontal: 'left' },
                    border: {
                        top: { style: 'thin' },
                        left: { style: 'thin' },
                        bottom: { style: 'thin' },
                        right: { style: 'thin' }
                    }
                };

                headerRow.eachCell(cell => {
                    cell.font = headerStyle.font;
                    cell.fill = headerStyle.fill;
                    cell.alignment = headerStyle.alignment;
                    cell.border = headerStyle.border;
                });

                data.forEach(row => {
                    worksheet.addRow(Object.values(row));
                });

                worksheet.columns.forEach(column => {
                    let maxContentWidth = 10;
                    column.eachCell({ includeEmpty: true }, cell => {
                        if (cell.value) {
                            const cellText = cell.value.toString();
                            maxContentWidth = Math.max(maxContentWidth, cellText.length);
                        }
                    });
                    column.width = Math.min(maxContentWidth + 2, 30);
                });

                workbook.xlsx.writeBuffer().then(buffer => {
                    const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = filename;
                    link.click();
                });
            }
            procesarArchivos()

        }

        function procesarAvon() {
            async function procesarArchivos() {
                const fileAcuerdos = document.getElementById('fileAcuerdos').files[0];
                const fileCartera = document.getElementById('fileCarteraAv').files[0];

                if (!fileAcuerdos || !fileCartera) {
                    alert('Seleccione ambos archivos');
                    return;
                }

                const [acuerdosData, carteraData] = await Promise.all([
                    leerExcel(fileAcuerdos),
                    leerExcel(fileCartera)
                ]);

                if (!acuerdosData.length || !carteraData.length) {
                    alert('Los archivos están vacíos o no contienen datos válidos');
                    return;
                }

                const normalizarCabeceras = obj => Object.keys(obj).reduce((acc, key) => {
                    acc[key.trim()] = obj[key];
                    return acc;
                }, {});

                const acuerdosNormalizadas = acuerdosData.map(normalizarCabeceras);
                const carteraNormalizada = carteraData.map(normalizarCabeceras);

                if (!acuerdosNormalizadas[0].hasOwnProperty("Ci") || !carteraNormalizada[0].hasOwnProperty("CASOS ACTIVOS AVON")) {
                    alert('Verifique que los archivos contengan las cabeceras correctas (Ci y Cliente)');
                    return;
                }

                const limpiarCi = (ci) => String(ci).replace(/-/g, '').trim();
                let documentosCartera = new Set(carteraNormalizada.map(row => limpiarCi(row["CASOS ACTIVOS AVON"])));

                let acuerdosFiltrados = acuerdosNormalizadas.filter(row => documentosCartera.has(limpiarCi(row["Ci"])));
                const responseMessageAv = document.getElementById('responseMessageAv');

            
                if (acuerdosFiltrados.length === 0) {
                    responseMessageAv.innerHTML = "<div class='alert alert-danger text-center'>❌ No se encontraron ci en Avon.</div>";
                    return;
                }
                
                acuerdosNormalizadas.forEach(row => {
                    let doc = limpiarCi(row["Ci"]);
                    if (documentosCartera.has(doc)) {
                        row["Cartera"] = "Avon";
                    }
                });
                descargarExcel(acuerdosFiltrados, 'Avon.xlsx');
            }

            function leerExcel(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const sheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(sheet);
                        resolve(jsonData);
                    };
                    reader.onerror = reject;
                    reader.readAsArrayBuffer(file);
                });
            }

            function descargarExcel(data, filename) {
                const workbook = new ExcelJS.Workbook();
                const worksheet = workbook.addWorksheet("Datos");

                const headerRow = worksheet.addRow(Object.keys(data[0] || {}));
                const headerStyle = {
                    font: { bold: true, color: { argb: 'FFFFFFFF' } },
                    fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF002060' } },
                    alignment: { horizontal: 'left' },
                    border: {
                        top: { style: 'thin' },
                        left: { style: 'thin' },
                        bottom: { style: 'thin' },
                        right: { style: 'thin' }
                    }
                };

                headerRow.eachCell(cell => {
                    cell.font = headerStyle.font;
                    cell.fill = headerStyle.fill;
                    cell.alignment = headerStyle.alignment;
                    cell.border = headerStyle.border;
                });

                data.forEach(row => {
                    worksheet.addRow(Object.values(row));
                });

                worksheet.columns.forEach(column => {
                    let maxContentWidth = 10;
                    column.eachCell({ includeEmpty: true }, cell => {
                        if (cell.value) {
                            const cellText = cell.value.toString();
                            maxContentWidth = Math.max(maxContentWidth, cellText.length);
                        }
                    });
                    column.width = Math.min(maxContentWidth + 2, 30);
                });

                workbook.xlsx.writeBuffer().then(buffer => {
                    const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = filename;
                    link.click();
                });
            }


            procesarArchivos()
        }
    </script>
</body>

</html>