<!DOCTYPE html>

<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reportes</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.1/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="/">Home</a>
                    </li>
                </ul>
            </div>
            <span class="navbar-text mx-auto fw-bold">VIEMVENTURA</span>
        </div>
    </nav>

    <div class="container my-5">
        <div class="row">
            <div class="col-md-6">
                <div class="text-center mb-4">
                    <h1>Reporte Gestiones Mango</h1>
                </div>
                <input type="file" id="csvInput2" class="form-control mb-3">
                <button onclick="processCSVGestion()" class="btn btn-primary mb-2">Procesar primer archivo</button>
                <!-- Contenedor para el mensaje de carga -->
                <pre id="output2" class="mt-3" style="background: #f8f9fa; padding: 10px; border: 1px solid #ddd;">
                    <div id="loading2" class="text-center" style="display:none;">
                        <p>Procesando datos...</p>
                    </div>
                </pre>
            </div>
            <div class="col-md-6">
                <div class="text-center mb-4">
                    <h1>Reporte IVR</h1>
                </div>
                <input type="file" id="csvInput1" class="form-control mb-3">
                <button onclick="processIVR()" class="btn btn-primary mb-2">Procesar Archivo</button>
                <pre id="output1" class="mt-3" style="background: #f8f9fa; padding: 10px; border: 1px solid #ddd;">
                     <!-- Contenedor para el mensaje de carga -->
                <div id="loading1" class="text-center" style="display:none;">
                    <p>Procesando datos...</p>
                </div>
                </pre>
            </div>
        </div>
        <button onclick="downloadCombinedExcel()" class="btn btn-success mb-2 mt-4">Descargar Excel Combinado</button>
    </div>

    <script>

        function formatearfechaGestion(date) {
            if (!date) return "";
            const [datePart, timePart] = date.split(' '); // Ejemplo: ["2024-12-26", "12:30:50"]
            if (!datePart) return "";
            const [year, month, day] = datePart.split('-'); // Ejemplo: ["2024", "12", "26"]
            if (!year || !month || !day) return "";
            const formattedDate = new Date(`${year}-${month}-${day} ${timePart || ''}`);
            if (isNaN(formattedDate)) return "";
            const yearFormatted = formattedDate.getFullYear();
            const monthFormatted = String(formattedDate.getMonth() + 1).padStart(2, '0');
            const dayFormatted = String(formattedDate.getDate()).padStart(2, '0');
            return `${dayFormatted}/${monthFormatted}/${yearFormatted}`;
        }

        function formatearfecha(date) {
            if (!date) return "";
            const dateParts = date.split(' ')[0].split('/');
            if (dateParts.length !== 3) return "";
            const [day, month, year] = dateParts;
            return `${String(day).padStart(2, '0')}/${String(month).padStart(2, '0')}/${year}`;
        }

        function formatearfechaSola(date) {
            const fecha = new Date(date);
            if (isNaN(fecha)) return "";
            const day = String(fecha.getDate()).padStart(2, '0');
            const month = String(fecha.getMonth() + 1).padStart(2, '0');
            const year = fecha.getFullYear();
            return `${day}/${month}/${year}`;
        }

        function observacion(res, obs) {
            if (res === "Envio de acuerdo-Maga" || res === "Envio de acuerdo-Capta" || res === "Envio de acuerdo-Clearing") {
                return "Se envia correo con detalle de acuerdo";
            } else if (res === "Bienvenida-Clearing" || res === "Bienvenida-Capta" || res === "Bienvenida-Maga") {
                return "Correo notificando deuda e invitando a solucionar"
            } else if (res === "Se mudo") {
                return "La persona ya no vive ahi"
            } else {
                return obs;
            }
        }

        const ResultadosMapping = {
            "Acuerdo libre": "Promesa de pago", //*
            "Aviso": "Contacto Directo", //* ingreso de Datos?
            "Bajo acuerdo": "Promesa de pago",//* ver (no se logra promesa del pago) 
            "Confirma acuerdo": "Promesa de pago", //*
            "Contactado": "Contacto Directo", //*
            // EDICION DE CUENTA NO ESTA
            "Equivocado": "No conoce al titular", //*
            "Fallecido": "Titular Fallecido", //*
            "Imposibilidad inmediata de pago": "Sin voluntad de pago", //*
            "Mensaje directo": "Contacto Directo",//*ver
            "No contesta": "No Contesta", //*
            "Pago a imputar": "Promesa de pago",  //*
            "Fuera de servicio": "Fuera de servicio", //*
            "Mensaje indirecto": "Mensaje a tercero", //*
            "No tiene voluntad de arreglo": "Sin voluntad de pago", //*
            "Cambio de linea": "Busqueda de Datos",//*ver
            "No tiene dinero": "Sin voluntad de pago",//*
            "Ocupado": "Ocupado", //*
            "Acuerdo cumplido": "pago", //*
            "Imposible ubicar titular": "No conoce al titular", //*
            "No reconoce deuda": "No reconoce deuda", //*
            "Mensaje contestador": "Mensaje de voz", //*
            "Cancelado": "No se logra promesa de pago", //Promesa de pago
            "Dice que pago": "Aviso de Pago", //*
            "Bienvenida-Capta": " Ingreso de Datos",
            "Bienvenida-Clearing": " Ingreso de Datos",
            "Bienvenida-Maga": " Ingreso de Datos",
            "Envio de acuerdo-Maga": "Promesa de pago",
            "Envio de acuerdo-Capta": "Promesa de pago",
            "Envio de acuerdo-Clearing": "Promesa de pago",
            "Se mudo": "Contacto con terceros",
        };

        let processedData1 = [];
        let processedData2 = [];

        function processIVR() {
            const fileInput = document.getElementById("csvInput1");
            const file = fileInput.files[0];

            if (!file) {
                alert("Por favor, selecciona un archivo CSV.");
                return;
            }

            document.getElementById("loading1").style.display = "block";

            const reader = new FileReader();
            reader.onload = function (e) {
                const csvData = e.target.result;

                Papa.parse(csvData, {
                    skipEmptyLines: true,
                    delimiter: ";",
                    complete: function (results) {
                        const data = results.data;

                        const rows = data.slice(1); // Excluir cabecera

                        //archivo ivr
                        processedData1 = rows.map(row => ({
                            "fecha": formatearfecha(row[1]),
                            "telefono": row[2],
                            "accion": "LLAMADA ENTRANTE - IVR",
                            "resultados": "LLAMADA ENTRANTE - IVR",
                            "res mango": "no existen",
                            "observacion": "",
                            "bcu": "Sin registro",
                            "Trabajo": "Sin registro",
                            "ci": row[10]?.trim() || "",
                        })).filter(row => row.ci && row.fecha); // Filtrar filas incompletas

                        document.getElementById("output1").textContent = `Archivo procesado: ${processedData1.length} registros encontrados.`;
                        document.getElementById("loading1").style.display = "none";
                    },
                    error: function (error) {
                        console.error("Error procesando el archivo CSV:", error);
                        alert("Hubo un error procesando el archivo.");
                        // Ocultar el mensaje de carga en caso de error
                        document.getElementById("loading1").style.display = "none";
                    }
                });
            };

            reader.readAsText(file);
        }

        function processCSVGestion() {
            const fileInput = document.getElementById("csvInput2");
            const file = fileInput.files[0];

            if (!file) {
                alert("Por favor, selecciona un archivo CSV.");
                return;
            }

            // Mostrar el mensaje de carga
            document.getElementById("loading2").style.display = "block";

            const reader = new FileReader();
            reader.onload = function (e) {
                const csvData = e.target.result;
                Papa.parse(csvData, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function (results) {
                        const inputData = results.data;

                        const filteredData = inputData.filter(row => row["Entidad"] === "CAPTA VIEMVENTURA");

                        processedData2 = filteredData
                            .filter(row => {
                                const excludedKeywords = [
                                    "bienvenida",
                                    "Recordatorio de cuota-Maga",
                                    "Recordatorio de cuota-Welp Fasa",
                                    "Recordatorio de cuota-Capta",
                                    "Recordatorio de cuota-Clearing",
                                    "reasignacion a usuario",
                                    "baja por pedido de entidad",
                                    "cancelacion anterior",
                                ];

                                const resultado = (row["resultados"] || "").trim().toLowerCase();

                                if (row["usuario"] === "admi.orange" || row["usuario"] === "baptista.nicolas" || row["usuario"] === "bonilla.valentina" || row["usuario"] === "carlos.olivera" || row["usuario"] === "costa.belen" || row["usuario"] === "cuna.marcos" || row["usuario"] === "emiliano.correa" || row["usuario"] === "sosa.martin" || row["usuario"] === "sosas.martin" || row["usuario"] === "supervisora.romina" || row["usuario"] === "lencina.rosario" || row["usuario"] === "supervisor.carlos" || row["usuario"] === "trias.estefani" || row["usuario"] === "veliz.romina" || row["usuario"] === "supervisor.rosario" || row["usuario"] === "sanchez.orhiana" || row["usuario"] === "supervisora.maga" || row["usuario"] === "tecnologia.carolain" || row["usuario"] === "farias.daniela" || row["usuario"] === "tecnologia.carolain" || row["usuario"] === "tecnologia.carolain" || row["usuario"] === "tecnologia.carolain" || row["usuario"] === "tecnologia.carolain" || row["usuario"] === "tecnologia.carolain" || row["usuario"] === "tecnologia.carolain" || row["usuario"] === "tecnologia.carolain" || row["usuario" === "Mango CRM :P"]) {
                                    return false;
                                }
                                if (row["usuario"].includes("Mango")) {
                                    return false;
                                }

                                if (resultado.includes("de acuerdo") || resultado.includes("de cuenta")) {
                                    return false;
                                }
                                return !excludedKeywords.some(keyword => resultado.includes(keyword));
                            })
                            .map(row => {
                                const resultado = row["resultados"];
                                // archvi gestions
                                return {
                                    "fecha": formatearfechaGestion(row["dtFechHora"]),
                                    "telefono": row["medioContacto"],
                                    "accion": row["tipoEntrada"], //AJUSTAR FORMATO
                                    "resultados": ResultadosMapping[resultado] || "Resultado no contemplado",
                                    "resultadoMango": row["resultados"],
                                    "observacion": observacion(resultado, row["cObservaci"]),
                                    "bcu": "Sin registro",
                                    "Trabajo": "Sin registro",
                                    "ci": row["NroDocu"],
                                };
                            });

                        document.getElementById("output2").textContent = JSON.stringify(processedData2, null, 2);

                        document.getElementById("loading2").style.display = "none";
                    },
                    error: function (error) {
                        console.error("Error procesando el archivo CSV:", error);
                        alert("Hubo un error procesando el archivo.");
                        // Ocultar el mensaje de carga en caso de error
                        document.getElementById("loading2").style.display = "none";
                    }
                });

            };

            reader.readAsText(file);
        }

        function downloadCombinedExcel() {
            if (!processedData1.length && !processedData2.length) {
                alert("No hay datos para descargar. Procesa ambos archivos primero.");
                return;
            }
            const workbook = new ExcelJS.Workbook();
            const worksheet = workbook.addWorksheet("Reporte");

            const combinedData = [...processedData1, ...processedData2];
            const headers = Object.keys(combinedData[0]);

            worksheet.addRow(headers);

            combinedData.forEach(row => {
                worksheet.addRow(Object.values(row));
            });

            workbook.xlsx.writeBuffer().then(buffer => {
                const blob = new Blob([buffer], { type: 'application/octet-stream' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = "ReporteClearing.xlsx";
                link.click();
            }).catch(err => {
                console.error("Error al generar el archivo Excel:", err);
            });
        }

        function downloadCombinedExcel() {
            if (!processedData1.length && !processedData2.length) {
                alert("No hay datos para descargar. Procesa ambos archivos primero.");
                return;
            }

            const workbook = new ExcelJS.Workbook();
            const worksheet = workbook.addWorksheet("Eventos");

            // Estilo para los encabezados
            const headerStyle = {
                font: { bold: true, color: { argb: 'FFFFFFFF' } }, // Texto blanco
                fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF002060' } }, // Fondo azul oscuro
                alignment: { horizontal: 'left' },
                border: {
                    top: { style: 'thin' },
                    left: { style: 'thin' },
                    bottom: { style: 'thin' },
                    right: { style: 'thin' }
                }
            };

            // Combinar datos procesados
            const combinedData = [...processedData1, ...processedData2];

            // Agregar encabezados
            const headers = Object.keys(combinedData[0] || {});
            const headerRow = worksheet.addRow(headers);

            headerRow.eachCell((cell) => {
                cell.font = headerStyle.font;
                cell.fill = headerStyle.fill;
                cell.alignment = headerStyle.alignment;
                cell.border = headerStyle.border;
            });

            // Agregar datos
            combinedData.forEach((rowData) => {
                worksheet.addRow(Object.values(rowData));
            });

            worksheet.columns = headers.map((header, index) => {
                const maxContentWidth = Math.max(
                    header.length,
                    ...combinedData.map(row => (row[header] || '').toString().length)
                ) + 2;

                return {
                    header,
                    key: header,
                    width: Math.min(maxContentWidth + 2, 30)
                };
            });


            workbook.xlsx.writeBuffer().then((buffer) => {
                const blob = new Blob([buffer], { type: 'application/octet-stream' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = "ReporteViemventura.xlsx";
                link.click();
            }).catch((err) => {
                console.error("Error al generar el archivo Excel:", err);
            });
        }



    </script>
</body>

</html>